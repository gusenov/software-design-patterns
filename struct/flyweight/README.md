Паттерн Flyweight позволяет совместно использовать громоздкие данные являющиеся
общими для каждого объекта. Если данные повторяются в каждом объекте, то
следует использовать этот паттерн чтобы ссылаться на один объект и сэкономить
память.

Flyweight - это объект минимизирующий использование памяти за счет использования
общих данных с другими подобными объектами. Применяется когда нужно использовать
большое количество объектов, но повтор каждого объекта влечет потребление
неприемлимого количества памяти. Часто использование некоторых частей объекта
может быть разделено с другими, и общей рекомендацией является вынесение этих
частей во внешние структуры и передача их во временное использование объектам,
которым это нужно.

Классическим применением паттерна является графическое представление символов в
текстовом процессоре. Вместо того чтобы держать для каждого символа в документе
глиф-объект со шрифтом и другими даннами о форматировании, каждый символ может
содержать ссылку на flyweight glyph object разделяемый каждым экземпляром
такого же символа в документе; а глиф-объект будет содержать только позицию в
документе.

Другой пример - [пул строк](https://ru.wikipedia.org/wiki/%D0%9F%D1%83%D0%BB_%D1%81%D1%82%D1%80%D0%BE%D0%BA).

*Обычно строка — это объект большого размера, требующий для своей работы
выделения большого блока памяти. Данная оптимизация выделяет память под строки
только при надобности, позволяя нескольким переменным указывать на одну цепочку
символов. Только если одна из переменных меняет своё содержимое, строка
копируется.* ([wikipedia](https://ru.wikipedia.org/wiki/%D0%9F%D1%83%D0%BB_%D1%81%D1%82%D1%80%D0%BE%D0%BA#%D0%9B%D0%B5%D0%BD%D0%B8%D0%B2%D1%8B%D0%B5_%D0%BF%D1%80%D0%B8%D1%81%D0%B2%D0%B0%D0%B8%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F_%D1%81%D1%82%D1%80%D0%BE%D0%BA))

Flyweight-объекты:

- хранят внутренее (инвариантное) состояние, которое может быть разделено с
другими - это позволяет переиспользовать (reuse, share) Flyweight-объекты вместо
создания каждый раз новых;
- предоставляют интерфейс через который можно передать внешнее (вариативное)
состояние - это нужно при выполнении Flyweight-операции.

Состояния:

- Intrinsic state is invariant (context independent) and therefore can be shared
(for example, the code of character 'A' in a given character set).
- Extrinsic state is variant (context dependent) and therefore can not be shared
and must be passed in (for example, the position of character 'A' in a
text document).

Структура:

![UML class and sequence diagram](W3sDesign_Flyweight_Design_Pattern_UML.jpg)

Диаграмма классов:

1. Клиент обращается к ```FlyweightFactory``` чтобы создать или получить
общедоступные Flyweight-объекты.
2. Клиент использует ```Flyweight``` интерфейс чтобы выполнить операцию передав
внешнее (вариативное) состояние ```flyweight.operation(extrinsicState))```.
3. Класс ```Flyweight1``` имплементирует интерфейс ```Flyweight``` и хранит
внутренее (инвариантное) состояние, которое может быть разделено с другими.

Диаграмма последовательности показывает run-time интеракции:

1. ```Client``` вызывает ```getFlyweight(key)``` у ```FlyweightFactory```
который создает и возвращает ```Flyweight1``` объект.
2. Затем вызывает ```operation(extrinsicState)``` у полученного ```Flyweight1```
объекта.
3. ```Client``` снова вызывает ```getFlyweight(key)``` у ```FlyweightFactory```,
который на этот раз возвращает уже созданный общедоступный ```Flyweight1```
объект.

Иммутабельность и равенство:

Для безопасного общего использования клиентов и потоков, Flyweight-объекты
должны быть иммутабельны. Flyweight-объекты по определению являются
value-объектами. Идентичность экземпляров не имеет никакого значения поэтому
два Flyweight-экземпляра с одинаковыми значениями считаются равными.
